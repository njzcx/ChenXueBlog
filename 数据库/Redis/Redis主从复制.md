## 原理

Redis主从复制基于“”，整个过程可以分为 Full-ReSync, Command-Propagate, Partical-ReSync 总共 3 阶段。

```shell
             +----------------------+                +---------------------+
             | redisServer (master) |                | redisServer (slave) |
             |    localhost:6379    |                |    localhost:6380   |
             +----------------------+                +---------------------+ 
             |        slaves        |                |        master       | 
             +----------------------+                +---------------------+ 
                        |                                       |
                 +----------------+                      +-------------+
                 | redisClient[?] |                      | redisClient |  
                 +----------------+                      +-------------+
                                                                |
       ^                <<<<<<<<<<<<<<<<<< PING <<<<<<<<<<<<<<<<<                
       |                |                                               Step 1 : 检查套接字与 master 状态
       |                >>>>>>>>>>>>> PONG / NOAUTH >>>>>>>>>>>>>                
       |                                                        |                
       |                <<<<<<<<<<<<<<<<<< AUTH <<<<<<<<<<<<<<<<<                
       |                |                                               Step 2 : 身份验证
       |                >>>>>>>>>>>>>>>>>>> OK >>>>>>>>>>>>>>>>>>                
       |                                                        |                
       |                <<<< REPLCONF listening-port [port] <<<<<                
       |                |                                               Step 3 : 发送 slave 端口 
   Full-ReSync          >>>>>>>>>>>>>>>>>>> OK >>>>>>>>>>>>>>>>>>           
       |                                                        |                
       |                <<<<<< REPLCONF capa [eof|psync2] <<<<<<<                
       |                |                                               Step 4 : 检查命令兼容性
       |                >>>>>>>>>>>>>>>>>>> OK >>>>>>>>>>>>>>>>>>                
       |                                                        |                
       |                <<<<<<<<<<<<<< PSYNC ? -1 <<<<<<<<<<<<<<<                
       |                |                                                        
       |                >>>>>> FULLRESYNC [replid] [offset] >>>>>       Step 6 : 执行全量同步
       |                V                                                        
       |              BGSAVE                                                     
       |                V                                                        
       v                >>>>>>>>>>>>> RDB Snapshot >>>>>>>>>>>>>>                


       ^                <<<<<<<<< REPLCONF ACK [offset] <<<<<<<<<               
       |                >>>>>>>>>>>>>>> COMMAND 1 >>>>>>>>>>>>>>>                
       |                >>>>>>>>>>>>>>> COMMAND 2 >>>>>>>>>>>>>>>                
       |                <<<<<<<< REPLCONF ACK [offset+?] <<<<<<<<       心跳检测 & 命令传播         
Command-Propagate       >>>>>>>>>>>>>>>>>> PING >>>>>>>>>>>>>>>>>          
       |                >>>>>>>>>>>>>>> COMMAND 3 >>>>>>>>>>>>>>>                
       |                <<<<<<<< REPLCONF ACK [offset+?] <<<<<<<<                
       |                <<<<<<<< REPLCONF ACK [offset+?] <<<<<<<<                
       v                >>>>>>>>>>>>>>>>>> PING >>>>>>>>>>>>>>>>>                


       ^                =========================================                
       |                ====== The Same With Full-ReSync ========                
       |                =========================================                
       |                                                        |                
  Partical-ReSync       <<<<<<<< PSYNC [replid] [offset] <<<<<<<<       重连后执行部分同步
       |                |                                                        
       |                >>>>>>>>>>>>>>> CONTINUE >>>>>>>>>>>>>>>>                
       |                >>>>>>>>>>>>>>> COMMAND N >>>>>>>>>>>>>>>                
       v                >>>>>>>>>>>>>>> COMMAND ... >>>>>>>>>>>>>  
```

