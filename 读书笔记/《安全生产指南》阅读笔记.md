## 面向失败设计 理论篇	

### 一、面向失败设计概述

​	故障注定会发生，随着时间的流逝一切软硬件运行终将失败，而保障业务持续可用，取决于我们愿意投入多少精力和成本，沉淀多少能力，是否预料到不可知的情况。

​	因为失败无处不在，尤其当系统架构复杂性增高，随之而来的失败概率也提高了。

> 一个优秀的架构师，通常是一个悲观主义、现实主义者。

**失败原因可能有**：

- 硬件问题：硬件会老化、会被外力损坏、有残次品率
- 软件bug：没有人可以保证程序没有bug，再者现在升级迭代比较快，bug不可避免
- 配置变更错误：运维变更考虑不全而疏漏
- 系统恶化：长时间工作的程序不再可用。如自增变量越界，缓存、磁盘、数据库空间不足
- 超预期流量：双十一或健康码
- 外部攻击：流量或安全攻击。如：DDOS和CC攻击
- 依赖库问题：二方库、三方库可能存在漏洞
- 依赖服务问题：其他服务可能不可用、超时，这种失败导致自己服务不可能，导致持续辐射，变成大面积服务不可用。

**如何应对上述失败**：

面向失败设计，将失败当成系统设计的一部分，**能够从失败中快速恢复时面向失败的核心思想**。

- 冗余设计避免单点故障：集群多节点部署，数据库主备，存储多副本。
- 宏观多活架构：预防天灾人祸，冷备、热备、两地三中心、多活。
- 服务能力与依赖的自我保护：通过优良的设计，在任何系统破坏后，核心功能仍能够保持处于正常工作状态。如限流、降级等。
- 不可预料场景的预案：不是所有失败都可以自动恢复的，需要针对未知失败做好预案。
- 自动化运维管控：白屏运维，避免操作失误、决策失误。运维需要遵循灰度原则，降低失败的爆炸半径。
- 精细化监控体系：感知失败发生。监控告警、根因定位、智能预测、智能决策。
- 失败演练：面向失败设计做实践验证。

### 二、冗余设计避免单点故障

要解决单点故障，需要**通过冗余和隔离**实现。如：多机房、电力双线、双线网线网卡、磁盘冗余、主备数据库、集群多节点。

- 冗余可快速接入并承担已发生的故障。

- 隔离可使故障不影响现有系统的服务质量。

针对集群多节点，无状态节点扩容即可，有状态节点需要考虑：

- 状态同步：流量分配规则，如一致性Hash算法；或共享存储系统。
- 操作互斥：分布式锁；分区分割模式。
- 主节点冗余：主备部署；分布式选主。

站点架构一般采用分层解决单点故障。

单点故障的故障域局限于机房内的服务节点，当故障域扩大到机房、地域、光纤，则进入到容灾架构的领域中了。

### 三、宏观多活架构

容灾系统评估标准Share78：https://zhuanlan.zhihu.com/p/66835461

容灾系统的设计，主要受制于建设成本，分为7级。

**本章主要讲 集团多活容灾架构的思路和设计，其中包含优点和局限性。可作为竞品分析。**

### 四、服务能力与依赖的自我保护

分布式架构有很多依赖，为避免局部问题被放大成全局问题，需要以最小的粒度将失败隔离开，以保证系统稳定性。

- 尽早拦截无效请求：DDos清洗拦截同个IP同个用户的大量请求；对业务不产生实际意义的请求，如秒杀。
- 漏斗原则：越到链路后端，耗费资源越多，所以从前到后的请求量应逐级递减。如通过CDN、缓存手段。
- 隔离原则：1、下游弱依赖降级；2、下游强依赖隔离，通过线程池、信号量、并发数实现；3、异常机器可隔离；4、异常流量可隔离
- 流量错峰：匀速器来削峰填谷。
- 按需分配：provider通过QPS限流来提供服务，此外需要提供限流后的Fallback。
- 其他：失败请求用户体验；失败请求是否可以幂等

### 五、为失败准备预案

- 什么是预案
  - 预案是“知识点”和“经验教训”，在非系统预期的场景下，系统无法自己处理时的一些人工处置方案。
- 为什么要准备预案
  - 有些系统问题并没有规律可循，或没有自动化处理方式。但通过预案，可在关键时刻，将处理这些问题
  - 有前提条件需要预案：比如系统支持100个并发，那超过100个并发怎么办？
  - 需要人工干涉的步骤需要预案：确保操作正确性。
  - 故障场景需要预案
  - 业务变更需要预案
- 如何准备预案
  - 预案执行前的判断条件要清晰
  - 预案执行步骤要准确、清晰
  - 预案执行后要有校验步骤
  - 预案执行的各参与角色尽量在流程上隔离，保证每个角色至关心自己范围内的事情。
  - 预案的生命周期：梳理预案（明确需要预案的风险点）、开发预案（针对风险点设计预案）、测试预案、演练预案（定期演练保证预案的准确性，预案的准确性应该是最高的）、下线预案。

### 六、精细化监控体系

## 面向失败设计 实践案例篇

### 一、架构域

#### 1、单点故障



2、负载不均

3、有状态

4、事后监控

5、不可回滚

6、不可降级

7、缺乏隔离

8、缺乏冗余备份

### 二、设计域

1、滥用日志策略

2、缺乏自我保护

3、缓存设计不当

4、容量评估不准

5、耦合过重

6、滥用同步

7、非幂等

8、敏感信息泄漏

9、对失败考虑不充分

10、数据库索引不合理

11、数据库表结构设计不合理

12、误用数据库limit查询

13、小表随意truncate

14、一次性批量delete数据

15、对异常状态进行兜底设计

16、对重要数据备份

### 三、发布域

1、无灰度流程

2、错误灰度方案

3、未经测试上线

4、预发未充分测试

5、无回滚方案

6、回滚方案未验证

7、未评估影响范围

### 四、变更域

1、变更没有记录

2、变更不可管控

3、变更数据没有格式化

4、变更封不封网

5、变更系统自身能力缺失

6、版本不一致

7、业务高峰期进行数据库变更

8、网络变更质量

### 五、编码域

1、魔法值的使用

2、比较包装类的对象值

3、POJO类属性

4、添加集合元素

5、集合遍历时的修改

6、集合排序异常

7、程序流程控制

8、高并发下的单例对象

9、高并发下的ThreadLocal

10、异常捕获处理

11、高并发下的HashMap

12、日志的使用

13、HTTP连接管理

14、参数检查

15、接口签名

16、不合理的参数配置

17、版本依赖问题

18、字符防乱码

19、不限制集合的大小

### 六、测试域

1、测试链路不完全

2、测试引发的性能问题

3、测试引发的数据污染

4、线上引流测试

5、建立测试基线

6、项目重构测试保障

### 七、监控告警域

1、监控误报成本浪费

2、指标采集不标准

3、基础设施产品未关注业务可用性

4、大面积coredump监控

5、监控失效

6、监控配置不合理

7、关键报警无人处理

8、缺乏分维度大盘

9、变更不关注业务监控

### 八、故障处理域

1、应急原则

2、应急启动

3、应急组织

4、跨域协作

5、应急指挥

6、故障复盘

7、快速恢复

## 读后感

- 始于2022年5月1日，计划于应终于2022年5月3日晚之前读完，即花2天的时间来学习。

- 阅读本书的目的：了解应用架构的失败设计理念和实践原则，从而提升自己在系统设计上的眼界。